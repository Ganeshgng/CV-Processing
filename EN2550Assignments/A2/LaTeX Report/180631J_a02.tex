\documentclass[a4paper,11pt]{article}%,twocolumn
\input{settings/packages}
\input{settings/page}
\input{settings/jupyter}




\begin{document}
	\begin{center}
		{\large \textbf{Assignment A02: Alignment}}\\
		Thalagala B.P.\hspace{0.5cm} 180631J 
	\end{center}
	\hrule
\section{2-D transformations}
As shown in the figures (a),(b) and (c) Translation and Rotation  preserves angles, area and the lengths of the 2D object subjected to the transformation. They also known as \textit{2D Euclidean transformation} due to the preservation of the Euclidean distances under the transformation. The similarity transform(\textit{Scaled rotation}) only preserves the angles between lines and the Affine transformation only preserves the parallelism of the lines while the Projective transformation distort all the mentioned properties and preserves only the straightness of the lines of the object.

\begin{figure}[!h]
	\centering
	\subfigure[Translation]
	{ \includegraphics[scale=0.4]{figures/Translation}
		
	}
	\subfigure[Rotation]
	{ \includegraphics[scale=0.4]{figures/Rotation}
		
	}
	\subfigure[Rotation + Translation]
	{ \includegraphics[scale=0.38]{figures/2DEuclidean}
		
	}
	\subfigure[Similarity Transform]
	{ \includegraphics[scale=0.35]{figures/similarity}
		
	}
	\subfigure[Affine]
	{ \includegraphics[scale=0.35]{figures/Affine}
		
	}
	\subfigure[Projective]
	{ \includegraphics[scale=0.35]{figures/Projective}
		
	}
	\caption{2-D transformations \textit{Note that: Figures are not in the same scale.}}
\end{figure}  
Following code snippet consists of all the transformation matrices used to generate the above figures in the given order.\\ 	
    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{1}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} Translation}
\PY{n}{t} \PY{o}{=} \PY{l+m+mi}{1} \PY{c+c1}{\PYZsh{} translation along each axis}
\PY{n}{H} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{n}{t}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{,}\PY{n}{t}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}
\PY{c+c1}{\PYZsh{} Rotation }
\PY{n}{theta} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{pi}\PY{o}{/}\PY{l+m+mi}{4} \PY{c+c1}{\PYZsh{} Anti clockwise pi/4 rad rotation}
\PY{n}{H} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{l+m+mf}{0.}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{l+m+mf}{0.}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mf}{0.}\PY{p}{,} \PY{l+m+mf}{0.}\PY{p}{,} \PY{l+m+mf}{1.}\PY{p}{]}\PY{p}{]}
\PY{c+c1}{\PYZsh{} Rotation + translation.(2D Euclidean transformation)}
\PY{n}{H} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{n}{t}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{n}{t}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mf}{0.}\PY{p}{,} \PY{l+m+mf}{0.}\PY{p}{,} \PY{l+m+mf}{1.}\PY{p}{]}\PY{p}{]}
\PY{c+c1}{\PYZsh{} Scaled rotation (similarity transform)}
\PY{n}{s} \PY{o}{=} \PY{l+m+mf}{0.5}
\PY{n}{H} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{s}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{s}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{n}{t}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{n}{s}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{sin}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{n}{s}\PY{o}{*}\PY{n}{np}\PY{o}{.}\PY{n}{cos}\PY{p}{(}\PY{n}{theta}\PY{p}{)}\PY{p}{,} \PY{n}{t}\PY{p}{]}\PY{p}{,} \PY{p}{[}\PY{l+m+mf}{0.}\PY{p}{,} \PY{l+m+mf}{0.}\PY{p}{,} \PY{l+m+mf}{1.}\PY{p}{]}\PY{p}{]}
\PY{c+c1}{\PYZsh{} Affine Transformation: An arbitrary 2 by 3 Matrix}
\PY{n}{a00} \PY{o}{=} \PY{l+m+mi}{3} \PY{p}{;} \PY{n}{a01} \PY{o}{=} \PY{l+m+mi}{2} \PY{p}{;} \PY{n}{a02} \PY{o}{=} \PY{l+m+mi}{3}
\PY{n}{a10} \PY{o}{=} \PY{l+m+mi}{1} \PY{p}{;} \PY{n}{a11} \PY{o}{=} \PY{l+m+mi}{3} \PY{p}{;} \PY{n}{a12} \PY{o}{=} \PY{l+m+mi}{3}
\PY{n}{H} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{a00}\PY{p}{,} \PY{n}{a01}\PY{p}{,} \PY{n}{a02}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{a10}\PY{p}{,} \PY{n}{a11}\PY{p}{,} \PY{n}{a12}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}
\PY{c+c1}{\PYZsh{} Projective(Perspective transform or Homography): An arbitrary 3 by 3 Matrix}
\PY{n}{a20} \PY{o}{=} \PY{l+m+mf}{1.5} \PY{p}{;} \PY{n}{a21} \PY{o}{=} \PY{l+m+mi}{2}\PY{p}{;} \PY{n}{a22} \PY{o}{=} \PY{l+m+mi}{1}
\PY{n}{H} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n}{a00}\PY{p}{,} \PY{n}{a01}\PY{p}{,} \PY{n}{a02}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{a10}\PY{p}{,} \PY{n}{a11}\PY{p}{,} \PY{n}{a12}\PY{p}{]}\PY{p}{,}\PY{p}{[}\PY{n}{a20}\PY{p}{,}\PY{n}{a21}\PY{p}{,}\PY{n}{a22}\PY{p}{]}\PY{p}{]}
\end{Verbatim}
\end{tcolorbox}
%---------------------------------------------------------------
\section{Warping Using a Given Homography}  

Following figure shows the transformation of the  \href{https://www.robots.ox.ac.uk/~vgg/data/affine/}{Graffiti} {\tt img1.ppm} onto {\tt img5.ppm} using the provided homography matrix. Consider the area enclosed using the yellow colored bounding box in the figure(d). The transition between two images is almost unnoticeable and it will be completely seamless if  intensities of the pixels around the transition area are perfectly matched.\\

\begin{figure}[!h]
	\centering
	\subfigure[Image 1]
	{ \includegraphics[scale=0.2]{figures/im1}
		
	}
	\subfigure[Image 5]
	{ \includegraphics[scale=0.2]{figures/im5}
		
	}\\
	\subfigure[Warped Image 5]
	{ \includegraphics[scale=0.175]{figures/im5warped}
		
	}
	\subfigure[Stitched Images]
	{ \includegraphics[scale=0.29]{figures/im5warped2}		
	}
	\caption{Warping Using a Given Homography}
	\label{fig:givenhomo}
\end{figure}  
{\scriptsize

\[
H1to5p = 
\begin{bmatrix}
   6.2544644e-01&   5.7759174e-02&   2.2201217e+02\\
2.2240536e-01   &1.1652147e+00  &-2.5605611e+01\\
4.9212545e-04 & -3.6542424e-05 &  1.0000000e+00\\
\end{bmatrix}
\]}
    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{2}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{} Loading im1.ppm and im5.ppm}
\PY{n}{im1} \PY{o}{=} \PY{n}{cv}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{../images/graf/img1.ppm}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{cv}\PY{o}{.}\PY{n}{IMREAD\PYZus{}ANYCOLOR}\PY{p}{)}
\PY{n}{im5} \PY{o}{=} \PY{n}{cv}\PY{o}{.}\PY{n}{imread}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{../images/graf/img5.ppm}\PY{l+s+s1}{\PYZsq{}}\PY{p}{,} \PY{n}{cv}\PY{o}{.}\PY{n}{IMREAD\PYZus{}ANYCOLOR}\PY{p}{)}
\PY{c+c1}{\PYZsh{} Loading the given Homography H1to5p}
\PY{k}{with} \PY{n+nb}{open}\PY{p}{(}\PY{l+s+s1}{\PYZsq{}}\PY{l+s+s1}{../images/graf/H1to5p}\PY{l+s+s1}{\PYZsq{}}\PY{p}{)} \PY{k}{as} \PY{n}{f}\PY{p}{:}
    \PY{n}{H} \PY{o}{=} \PY{p}{[}\PY{p}{[}\PY{n+nb}{float}\PY{p}{(}\PY{n}{x}\PY{p}{)} \PY{k}{for} \PY{n}{x} \PY{o+ow}{in} \PY{n}{line}\PY{o}{.}\PY{n}{split}\PY{p}{(}\PY{p}{)}\PY{p}{]} \PY{k}{for} \PY{n}{line} \PY{o+ow}{in} \PY{n}{f}\PY{p}{]}
\PY{n}{H} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{H}\PY{p}{)}
\PY{n}{im5\PYZus{}warped} \PY{o}{=} \PY{n}{cv}\PY{o}{.}\PY{n}{warpPerspective}\PY{p}{(}\PY{n}{im5}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{H}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{900}\PY{p}{,}\PY{l+m+mi}{900}\PY{p}{)}\PY{p}{)}
\PY{n}{im5\PYZus{}warped}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{:}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]} \PY{o}{=} \PY{n}{im1}
\end{Verbatim}
\end{tcolorbox}
\vspace{0.5cm}
\hrule
\section{Computing the Homography Using Mouse-Clicked Points and Warping}

To calculate the homography at least 4 corresponding points are required. Following figures show the points used to calculate the homography matrix given below. There, 5 points marked in the light blue circles on each image were selected. Note that the same sets of points were used to calculate the homography using the custom function defined in the next section since it enables better comparison between the sections of this report. \\
 
\begin{figure}[!h]
	\centering
	\subfigure[Image 1]
	{ \includegraphics[scale=0.25]{figures/im1points}
		
	}
	\subfigure[Image 4]
	{ \includegraphics[scale=0.25]{figures/im4points}
	}
	\caption{Corresponding Points used to Calculate the Homography}
	
\end{figure}
 
Consider the area enclosed using the yellow colored bounding box in the sub figure(b) of Fig.\ref{findhomo}. Transition between two images is visible than that in the Fig.\ref{fig:givenhomo}. Human made error at the selection of corresponding points and low quality of the chosen points can be reasons for this imperfection as it was done through manual mouse clicking. However some of the values obtained for the elements of homography matrix is nearly closer to that of the original homography given in the aforementioned website.\\% and they are also included in the below table.
%\begin{table}[!h]
%	\centering
%	\begin{tabular}{|l|| c| c|}
%		\hline
%		\textbf{Point} & \textbf{Image 1} & \textbf{Image 4}\\\hline
%		&&\\
%		Point 1&[157. 560.]&[434. 631.]\\
%		Point 2&[141. 130.]&[143. 243.]\\
%		Point 3&[544. 542.]&[576. 486.]\\
%		Point 4&[405. 209.]&[325. 250.]\\
%		Point 5&[682.  056.]&[358.  081.]\\\hline
%	\end{tabular}
%	\caption{Corresponding Points in the two Images}
%\end{table}


\begin{figure}[!h]
	\centering
	\subfigure[Warped Image 4]
	{ \includegraphics[scale=0.175]{figures/im4warped}
		
	}
	\subfigure[Stitched Images]
	{ \includegraphics[scale=0.29]{figures/im4warped2}		
	}
	\caption{Warping Using the Homography calculated using {\tt cv.findHomography()} in OpenCV }
	\label{findhomo}
\end{figure}  



The homography matrix calculated using the above points and the OpenCV's {\tt cv.findHomography()} function is given below. 
{\scriptsize
\[
H = 
\begin{bmatrix}
 6.59894211e-01 &  6.86220378e-01& -3.13000247e+01\\
-1.50977725e-01  &9.56863356e-01  &1.52906596e+02\\
 4.12755346e-04& -1.98886486e-05  &1.00000000e+00\\
\end{bmatrix}
\]
}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{3}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{n}{H}\PY{p}{,} \PY{n}{status} \PY{o}{=} \PY{n}{cv}\PY{o}{.}\PY{n}{findHomography}\PY{p}{(}\PY{n}{p1}\PY{p}{,}\PY{n}{p2}\PY{p}{)}
\PY{n}{H} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{H}\PY{p}{)}
\PY{n}{im4\PYZus{}warped} \PY{o}{=} \PY{n}{cv}\PY{o}{.}\PY{n}{warpPerspective}\PY{p}{(}\PY{n}{im4}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{H}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{900}\PY{p}{,}\PY{l+m+mi}{900}\PY{p}{)}\PY{p}{)}
\PY{n}{im4\PYZus{}warped}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{:}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]} \PY{o}{=} \PY{n}{im1}
\end{Verbatim}
\end{tcolorbox}
\vspace{0.5cm}
\hrule

\section{Computing the Homogrpahy Using Mouse-Clicked Points and without OpenCV}

Following algorithm implements the \textbf{\textit{Normalized Direct Linear Transformation (DLT)}} method (described in the \textit{Multiple View Geometry in Computer Vision}(Second Edition), by \textit{Richard Hartley} and   \textit{Andrew Zisserman}), to find the homography matrix {\tt M}$_{3 \times 3}$ using 5 pairs of corresponding points. Let $x_i = [x , y, 1]$ and $x_i^\prime = [x\prime , y\prime, w\prime ] $  be two corresponding points in the given two images. Then the transformation is given by $x_i^\prime = Hx_i$. This equation can be represented by using the vector cross product as  $x_i^\prime \times Hx_i = 0$ sine both the components have the same direction even though they differ in magnitude. This equation can be further simplified  to obtain the following linearly independent  system of two equations corresponding to each pair of points. Where $h^j$ indicates the $j^{th}$ row of the Homography matrix and $j = {1,2,3}$.

{\footnotesize
\begin{equation*}
	\begin{bmatrix}
		0^\top & -w\prime x_i^\top & y\prime x_i^\top\\
		w\prime x_i^\top	& 0^\top & -x\prime x_i^\top\\
	\end{bmatrix}
	\begin{bmatrix}
		h^1\\
		h^2\\
		h^3
	\end{bmatrix} =
	\begin{bmatrix}
		0& 0 &0 & -w\prime.x&-w\prime.y&-w\prime.1& y\prime.x & y\prime.y& y\prime.1\\
		w\prime.x&w\prime.y&w\prime.1& 0& 0 &0 & -x\prime.x& -x\prime.y& -x\prime.1\\
	\end{bmatrix}
	\begin{bmatrix}
		h^1\\
		h^2\\
		h^3
	\end{bmatrix}
\end{equation*}
}

We can obtain 5 pairs of such equations and they can be put into a single matrix to solve for the unknown  $h^j$s through \textbf{\textit{Singular Value Decomposition}} as described in the {\tt Algorithm 4.1, 4.2 } in the above mentioned reference book. When Considering the area enclosed using the yellow colored bounding box in the sub figure(b) of Fig.\ref{clachomo}, discontinuous transition between two images is clearly visible than both the Fig.\ref{fig:givenhomo} and the Fig.\ref{findhomo}. In addition to the aforementioned reasons for this imperfection, low quality of the used algorithm may also be a reason since it is a very basic algorithm for homography calculation. 

\begin{figure}[!h]
	\centering
%	\subfigure[Image 1]
%	{ \includegraphics[scale=0.2]{figures/myim1points}
%		
%	}
%	\subfigure[Image 4]
%	{ \includegraphics[scale=0.2]{figures/myim4points}
%	}\\
	\subfigure[Warped Image 4]
	{ \includegraphics[scale=0.175]{figures/myim4warped}
		
	}
	\subfigure[Stitched Images]
	{ \includegraphics[scale=0.29]{figures/myim4warped2}		
	}
	\caption{Warping Using the Calculated Homography}
	\label{clachomo}
\end{figure} 

The homography calculated using the same points mentioned earlier and the {\tt calcHomography()} custom function defined below is given below. Even though some values of its elements are nearly closer to the ideal values it has unable to provide good results due to the previously mentioned reasons.  
{ \scriptsize
\[
H = 
\begin{bmatrix}
 6.60355290e-01&  6.85735356e-01 &-3.13168167e+01\\
-1.50699933e-01 & 9.56965356e-01 & 1.52763838e+02\\
 4.13108386e-04 &-2.02092511e-05 & 1.00000000e+00\\
\end{bmatrix}
\]
}

    \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
\prompt{In}{incolor}{4}{\boxspacing}
\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{}============================ Normalization ======================}
\PY{k}{def} \PY{n+nf}{normalizePoints}\PY{p}{(}\PY{n}{points}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
\PY{l+s+sd}{       Normalizing the point cloud(pre\PYZhy{}conditioning) }
\PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
    \PY{c+c1}{\PYZsh{} Calculating the centroid of the points.}
    \PY{n}{centroid} \PY{o}{=} \PY{n+nb}{sum}\PY{p}{(}\PY{n}{points}\PY{p}{)}\PY{o}{/}\PY{n+nb}{len}\PY{p}{(}\PY{n}{points}\PY{p}{)}
    \PY{c+c1}{\PYZsh{} Calculating the scaling factor.}
    \PY{n}{total\PYZus{}dist} \PY{o}{=} \PY{n+nb}{sum}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{n}{np}\PY{o}{.}\PY{n}{sum}\PY{p}{(}\PY{p}{(}\PY{p}{(}\PY{n}{points} \PY{o}{\PYZhy{}} \PY{n}{centroid}\PY{p}{)}\PY{o}{*}\PY{o}{*}\PY{l+m+mi}{2}\PY{p}{)}\PY{p}{,}\PY{n}{axis} \PY{o}{=} \PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{)}
    \PY{n}{avg\PYZus{}dist}  \PY{o}{=} \PY{n}{total\PYZus{}dist}\PY{o}{/}\PY{n+nb}{len}\PY{p}{(}\PY{n}{points}\PY{p}{)}
    \PY{c+c1}{\PYZsh{} For average distance from the origin to be sqrt(2) after scaling}
    \PY{n}{scale} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{sqrt}\PY{p}{(}\PY{l+m+mi}{2}\PY{p}{)}\PY{o}{/}\PY{n}{avg\PYZus{}dist}    
    \PY{c+c1}{\PYZsh{} Defining Similarity transformation: translation and scaling}
    \PY{n}{xt}\PY{p}{,} \PY{n}{yt} \PY{o}{=} \PY{n}{centroid}
    \PY{n}{transform} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{p}{[}\PY{p}{[}\PY{n}{scale}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{xt}\PY{o}{*}\PY{n}{scale}\PY{p}{]}\PY{p}{,}
                          \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{n}{scale}\PY{p}{,} \PY{o}{\PYZhy{}}\PY{n}{yt}\PY{o}{*}\PY{n}{scale}\PY{p}{]}\PY{p}{,}
                          \PY{p}{[}\PY{l+m+mi}{0}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]}\PY{p}{)}
    \PY{c+c1}{\PYZsh{} Making the points homogeneous by adding 1 at the end}
    \PY{n}{points} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{concatenate}\PY{p}{(}\PY{p}{(}\PY{n}{points}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{ones}\PY{p}{(}\PY{p}{(}\PY{n+nb}{len}\PY{p}{(}\PY{n}{points}\PY{p}{)}\PY{p}{,}\PY{l+m+mi}{1}\PY{p}{)}\PY{p}{)}\PY{p}{)}\PY{p}{,} \PY{n}{axis} \PY{o}{=}\PY{l+m+mi}{1}\PY{p}{)}
    \PY{c+c1}{\PYZsh{} Similarity transformation through matrix multiplication}
    \PY{n}{normalized\PYZus{}points} \PY{o}{=} \PY{n}{transform}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{points}\PY{o}{.}\PY{n}{T}\PY{p}{)}\PY{o}{.}\PY{n}{T}
    \PY{k}{return} \PY{n}{transform}\PY{p}{,} \PY{n}{normalized\PYZus{}points}
\end{Verbatim}
\end{tcolorbox}

Normalization of data points was also done using the above function in order to improve the performance of the algorithm defined below and to obtain a  better homography.\\ 


   \begin{tcolorbox}[breakable, size=fbox, boxrule=1pt, pad at break*=1mm,colback=cellbackground, colframe=cellborder]
	\prompt{In}{incolor}{4}{\boxspacing}
	\begin{Verbatim}[commandchars=\\\{\}]
\PY{c+c1}{\PYZsh{}===================== Calculating homography ====================}
\PY{k}{def} \PY{n+nf}{calcHomography}\PY{p}{(}\PY{n}{p1}\PY{p}{,}\PY{n}{p2}\PY{p}{)}\PY{p}{:}
    \PY{l+s+sd}{\PYZdq{}\PYZdq{}\PYZdq{}}
\PY{l+s+sd}{        The normalized DLT for 2D homographies.Given in the }
\PY{l+s+sd}{        "Multiple View Geometry in Computer Vision" Second Edition }
\PY{l+s+sd}{        by Richard Hartley \PYZam{} Andrew Zisserman. Algorithm 4.2 }
\PY{l+s+sd}{    \PYZdq{}\PYZdq{}\PYZdq{}}
    \PY{c+c1}{\PYZsh{} Normalizing the points using predefined function}
    \PY{n}{T1}\PY{p}{,}\PY{n}{p1} \PY{o}{=} \PY{n}{normalizePoints}\PY{p}{(}\PY{n}{p1}\PY{p}{)}
    \PY{n}{T2}\PY{p}{,}\PY{n}{p2} \PY{o}{=} \PY{n}{normalizePoints}\PY{p}{(}\PY{n}{p2}\PY{p}{)}
    \PY{c+c1}{\PYZsh{}Initialising an array to keep the coefficint matrix}
    \PY{n}{A} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{zeros}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{2}\PY{o}{*}\PY{n+nb}{len}\PY{p}{(}\PY{n}{p1}\PY{p}{)}\PY{p}{,} \PY{l+m+mi}{9}\PY{p}{)}\PY{p}{)}
    \PY{n}{row} \PY{o}{=} \PY{l+m+mi}{0}
    \PY{c+c1}{\PYZsh{} Filling rows of the matrix according to the expressions}
    \PY{k}{for} \PY{n}{point1}\PY{p}{,} \PY{n}{point2} \PY{o+ow}{in} \PY{n+nb}{zip}\PY{p}{(}\PY{n}{p1}\PY{p}{,}\PY{n}{p2}\PY{p}{)}\PY{p}{:}
        \PY{c+c1}{\PYZsh{} Coefficients of the current row }
        \PY{n}{A}\PY{p}{[}\PY{n}{row}\PY{p}{,} \PY{l+m+mi}{3}\PY{p}{:}\PY{l+m+mi}{6}\PY{p}{]} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{point2}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{point1}
        \PY{n}{A}\PY{p}{[}\PY{n}{row}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]} \PY{o}{=}  \PY{n}{point2}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{o}{*}\PY{n}{point1}
        \PY{c+c1}{\PYZsh{} Coefficients of the next row }
        \PY{n}{A}\PY{p}{[}\PY{n}{row}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{:}\PY{l+m+mi}{3}\PY{p}{]} \PY{o}{=}  \PY{n}{point2}\PY{p}{[}\PY{l+m+mi}{2}\PY{p}{]}\PY{o}{*}\PY{n}{point1}
        \PY{n}{A}\PY{p}{[}\PY{n}{row}\PY{o}{+}\PY{l+m+mi}{1}\PY{p}{,} \PY{l+m+mi}{6}\PY{p}{:}\PY{l+m+mi}{9}\PY{p}{]} \PY{o}{=} \PY{o}{\PYZhy{}}\PY{n}{point2}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{o}{*}\PY{n}{point1}    
        \PY{n}{row}\PY{o}{+}\PY{o}{=}\PY{l+m+mi}{2}    
    \PY{c+c1}{\PYZsh{} Singular Value decomposition of A}
    \PY{n}{U}\PY{p}{,} \PY{n}{D}\PY{p}{,} \PY{n}{VT} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{svd}\PY{p}{(}\PY{n}{A}\PY{p}{)}
    \PY{c+c1}{\PYZsh{} unit singular vector corresponding to the smallest }
    \PY{c+c1}{\PYZsh{} singular value, is the solution h. That is last column of V.}
    \PY{c+c1}{\PYZsh{} i.e. Last row of the V\PYZca{}T}
    \PY{n}{h} \PY{o}{=}   \PY{n}{VT}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}
    \PY{c+c1}{\PYZsh{} Reshaping to get 3x3 homography}
    \PY{n}{H} \PY{o}{=} \PY{n}{h}\PY{o}{.}\PY{n}{reshape}\PY{p}{(}\PY{p}{(}\PY{l+m+mi}{3}\PY{p}{,}\PY{l+m+mi}{3}\PY{p}{)}\PY{p}{)}
    \PY{c+c1}{\PYZsh{} Denormalization}
    \PY{n}{H} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{T2}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{H}\PY{p}{)}\PY{o}{.}\PY{n}{dot}\PY{p}{(}\PY{n}{T1}\PY{p}{)}
    \PY{n}{H} \PY{o}{=} \PY{n}{H}\PY{o}{/}\PY{n}{H}\PY{p}{[}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{,}\PY{o}{\PYZhy{}}\PY{l+m+mi}{1}\PY{p}{]}
    \PY{k}{return} \PY{n}{H}
    
\PY{c+c1}{\PYZsh{} Calculating Homography using the above function }    
\PY{n}{myH} \PY{o}{=} \PY{n}{calcHomography}\PY{p}{(}\PY{n}{p1}\PY{p}{,}\PY{n}{p2}\PY{p}{)}
\PY{n}{myH} \PY{o}{=} \PY{n}{np}\PY{o}{.}\PY{n}{array}\PY{p}{(}\PY{n}{H}\PY{p}{)}
\PY{c+c1}{\PYZsh{} Warping } 
\PY{n}{im4\PYZus{}warped} \PY{o}{=} \PY{n}{cv}\PY{o}{.}\PY{n}{warpPerspective}\PY{p}{(}\PY{n}{im4}\PY{p}{,} \PY{n}{np}\PY{o}{.}\PY{n}{linalg}\PY{o}{.}\PY{n}{inv}\PY{p}{(}\PY{n}{myH}\PY{p}{)}\PY{p}{,} \PY{p}{(}\PY{l+m+mi}{900}\PY{p}{,}\PY{l+m+mi}{900}\PY{p}{)}\PY{p}{)}
\PY{c+c1}{\PYZsh{} Stiching two images } 
\PY{n}{im4\PYZus{}warped}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{:}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{0}\PY{p}{]}\PY{p}{,} \PY{l+m+mi}{0}\PY{p}{:}\PY{n}{im1}\PY{o}{.}\PY{n}{shape}\PY{p}{[}\PY{l+m+mi}{1}\PY{p}{]}\PY{p}{]} \PY{o}{=} \PY{n}{im1}
\end{Verbatim}
\end{tcolorbox}
\vfill
\hrule
\begin{center}
	Executable code for this assignment can be found  \href{https://github.com/bimalka98/Computer-Vision-and-Image-Processing/blob/main/EN2550Assignments/A2/180631J_a02.ipynb}{here}.
\end{center}
  
\end{document}
